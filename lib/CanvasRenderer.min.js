!function(e,t){'function'==typeof define&&define.amd?define('three.CanvasRenderer',['three'],t):'undefined'!=typeof exports&&'undefined'!=typeof module?module.exports=t(require('three')):t(e.THREE)}(this,function(e){e.SpriteCanvasMaterial=function(t){e.Material.call(this),this.type='SpriteCanvasMaterial',this.color=new e.Color(16777215),this.program=function(){},this.setValues(t)},e.SpriteCanvasMaterial.prototype=Object.create(e.Material.prototype),e.SpriteCanvasMaterial.prototype.constructor=e.SpriteCanvasMaterial,e.SpriteCanvasMaterial.prototype.isSpriteCanvasMaterial=!0,e.SpriteCanvasMaterial.prototype.clone=function(){var t=new e.SpriteCanvasMaterial;return t.copy(this),t.color.copy(this.color),t.program=this.program,t},e.CanvasRenderer=function(t){console.log('THREE.CanvasRenderer',e.REVISION),t=t||{};var i=this,r,n,o,a=new e.Projector,s=void 0!==t.canvas?t.canvas:document.createElement('canvas'),l=s.width,c=s.height,p=Math.floor(l/2),d=Math.floor(c/2),f=0,h=0,m=l,v=c,u=1,y=s.getContext('2d',{alpha:!0===t.alpha}),x=new e.Color(0),g=!0===t.alpha?0:1,S=1,w=0,M=null,C=null,R=null,b=null,L=null,T=[],B,E,P,z,W,V,j,D,N,F=new e.Color,O=new e.Color,k=new e.Color,A=new e.Color,H={},I,G,U,q,J,K,Q,X=new e.Box2,Y=new e.Box2,Z=new e.Box2,$=new e.Color,_=new e.Color,ee=new e.Color,te=new e.Vector3,ie=new e.Vector3,re=new e.Vector3,ne=new e.Matrix3;function oe(){$.setRGB(0,0,0),_.setRGB(0,0,0),ee.setRGB(0,0,0);for(var e=0,t=o.length;e<t;e++){var i=o[e],r=i.color;i.isAmbientLight?$.add(r):i.isDirectionalLight?_.add(r):i.isPointLight&&ee.add(r)}}function ae(e,t,i){for(var r=0,n=o.length;r<n;r++){var a=o[r];if(A.copy(a.color),a.isDirectionalLight){var s=te.setFromMatrixPosition(a.matrixWorld).normalize(),l;if((l=t.dot(s))<=0)continue;l*=a.intensity,i.add(A.multiplyScalar(l))}else if(a.isPointLight){var s=te.setFromMatrixPosition(a.matrixWorld),l;if((l=t.dot(te.subVectors(s,e).normalize()))<=0)continue;if(0==(l*=0==a.distance?1:1-Math.min(e.distanceTo(s)/a.distance,1)))continue;l*=a.intensity,i.add(A.multiplyScalar(l))}}}function se(e,t,i){ue(i.opacity),ye(i.blending);var r=t.scale.x*p,n=t.scale.y*d,o=Math.sqrt(r*r+n*n);if(Z.min.set(e.x-o,e.y-o),Z.max.set(e.x+o,e.y+o),i.isSpriteMaterial){var a=i.map;if(null!==a){var s=H[a.id];if(void 0!==s&&s.version===a.version||(s=he(a),H[a.id]=s),void 0!==s.canvas){Me(s.canvas);var l=a.image,c=l.width*a.offset.x,f=l.height*a.offset.y,h=l.width*a.repeat.x,m=l.height*a.repeat.y,v=r/h,u=n/m;y.save(),y.translate(e.x,e.y),0!==i.rotation&&y.rotate(i.rotation),y.translate(-r/2,-n/2),y.scale(v,u),y.translate(-c,-f),y.fillRect(c,f,h,m),y.restore()}}else Me(i.color.getStyle()),y.save(),y.translate(e.x,e.y),0!==i.rotation&&y.rotate(i.rotation),y.scale(r,-n),y.fillRect(-.5,-.5,1,1),y.restore()}else i.isSpriteCanvasMaterial?(we(i.color.getStyle()),Me(i.color.getStyle()),y.save(),y.translate(e.x,e.y),0!==i.rotation&&y.rotate(i.rotation),y.scale(r,n),i.program(y),y.restore()):i.isPointsMaterial&&(Me(i.color.getStyle()),y.save(),y.translate(e.x,e.y),0!==i.rotation&&y.rotate(i.rotation),y.scale(r*i.size,-n*i.size),y.fillRect(-.5,-.5,1,1),y.restore())}function le(t,i,r,n){if(ue(n.opacity),ye(n.blending),y.beginPath(),y.moveTo(t.positionScreen.x,t.positionScreen.y),y.lineTo(i.positionScreen.x,i.positionScreen.y),n.isLineBasicMaterial){if(xe(n.linewidth),ge(n.linecap),Se(n.linejoin),n.vertexColors!==e.VertexColors)we(n.color.getStyle());else{var o=r.vertexColors[0].getStyle(),a=r.vertexColors[1].getStyle();if(o===a)we(o);else{try{var s=y.createLinearGradient(t.positionScreen.x,t.positionScreen.y,i.positionScreen.x,i.positionScreen.y);s.addColorStop(0,o),s.addColorStop(1,a)}catch(e){s=o}we(s)}}n.isLineDashedMaterial&&Ce([n.dashSize,n.gapSize]),y.stroke(),Z.expandByScalar(2*n.linewidth),n.isLineDashedMaterial&&Ce([])}}function ce(t,r,n,o,a,s,l,c){if(i.info.render.vertices+=3,i.info.render.faces++,ue(c.opacity),ye(c.blending),z=t.positionScreen.x,W=t.positionScreen.y,V=r.positionScreen.x,j=r.positionScreen.y,D=n.positionScreen.x,N=n.positionScreen.y,pe(z,W,V,j,D,N),(c.isMeshLambertMaterial||c.isMeshPhongMaterial||c.isMeshStandardMaterial)&&null===c.map)O.copy(c.color),k.copy(c.emissive),c.vertexColors===e.FaceColors&&O.multiply(l.color),F.copy($),ie.copy(t.positionWorld).add(r.positionWorld).add(n.positionWorld).divideScalar(3),ae(ie,l.normalModel,F),F.multiply(O).add(k),!0===c.wireframe?de(F,c.wireframeLinewidth,c.wireframeLinecap,c.wireframeLinejoin):fe(F);else if(c.isMeshBasicMaterial||c.isMeshLambertMaterial||c.isMeshPhongMaterial||c.isMeshStandardMaterial){var p;if(null!==c.map)c.map.mapping===e.UVMapping&&(I=l.uvs,me(z,W,V,j,D,N,I[o].x,I[o].y,I[a].x,I[a].y,I[s].x,I[s].y,c.map));else null!==c.envMap?c.envMap.mapping===e.SphericalReflectionMapping&&(re.copy(l.vertexNormalsModel[o]).applyMatrix3(ne),G=.5*re.x+.5,U=.5*re.y+.5,re.copy(l.vertexNormalsModel[a]).applyMatrix3(ne),q=.5*re.x+.5,J=.5*re.y+.5,re.copy(l.vertexNormalsModel[s]).applyMatrix3(ne),K=.5*re.x+.5,Q=.5*re.y+.5,me(z,W,V,j,D,N,G,U,q,J,K,Q,c.envMap)):(F.copy(c.color),c.vertexColors===e.FaceColors&&F.multiply(l.color),!0===c.wireframe?de(F,c.wireframeLinewidth,c.wireframeLinecap,c.wireframeLinejoin):fe(F))}else c.isMeshNormalMaterial?(re.copy(l.normalModel).applyMatrix3(ne),F.setRGB(re.x,re.y,re.z).multiplyScalar(.5).addScalar(.5),!0===c.wireframe?de(F,c.wireframeLinewidth,c.wireframeLinecap,c.wireframeLinejoin):fe(F)):(F.setRGB(1,1,1),!0===c.wireframe?de(F,c.wireframeLinewidth,c.wireframeLinecap,c.wireframeLinejoin):fe(F))}function pe(e,t,i,r,n,o){y.beginPath(),y.moveTo(e,t),y.lineTo(i,r),y.lineTo(n,o),y.closePath()}function de(e,t,i,r){xe(t),ge(i),Se(r),we(e.getStyle()),y.stroke(),Z.expandByScalar(2*t)}function fe(e){Me(e.getStyle()),y.fill()}function he(t){if(0===t.version||t instanceof e.CompressedTexture||t instanceof e.DataTexture)return{canvas:void 0,version:t.version};var i=t.image;if(!1===i.complete)return{canvas:void 0,version:0};var r=t.wrapS===e.RepeatWrapping||t.wrapS===e.MirroredRepeatWrapping,n=t.wrapT===e.RepeatWrapping||t.wrapT===e.MirroredRepeatWrapping,o=t.wrapS===e.MirroredRepeatWrapping,a=t.wrapT===e.MirroredRepeatWrapping,s=document.createElement('canvas');s.width=i.width*(o?2:1),s.height=i.height*(a?2:1);var l=s.getContext('2d');l.setTransform(1,0,0,-1,0,i.height),l.drawImage(i,0,0),!0===o&&(l.setTransform(-1,0,0,-1,i.width,i.height),l.drawImage(i,-i.width,0)),!0===a&&(l.setTransform(1,0,0,1,0,0),l.drawImage(i,0,i.height)),!0===o&&!0===a&&(l.setTransform(-1,0,0,1,i.width,0),l.drawImage(i,-i.width,i.height));var c='no-repeat';!0===r&&!0===n?c='repeat':!0===r?c='repeat-x':!0===n&&(c='repeat-y');var p=y.createPattern(s,c);return t.onUpdate&&t.onUpdate(t),{canvas:p,version:t.version}}function me(e,t,i,r,n,o,a,s,l,c,p,d,f){var h=H[f.id];if(void 0!==h&&h.version===f.version||(h=he(f),H[f.id]=h),void 0===h.canvas)return Me('rgba( 0, 0, 0, 1)'),void y.fill();Me(h.canvas);var m,v,u,x,g,S,w,M,C=f.offset.x/f.repeat.x,R=f.offset.y/f.repeat.y,b=f.image.width*f.repeat.x,L=f.image.height*f.repeat.y;l=(l+C)*b,c=(c+R)*L,p=(p+C)*b,d=(d+R)*L,i-=e,r-=t,n-=e,o-=t,0!==(w=(l-=a=(a+C)*b)*(d-=s=(s+R)*L)-(p-=a)*(c-=s))&&(g=e-(m=(d*i-c*n)*(M=1/w))*a-(u=(l*n-p*i)*M)*s,S=t-(v=(d*r-c*o)*M)*a-(x=(l*o-p*r)*M)*s,y.save(),y.transform(m,v,u,x,g,S),y.fill(),y.restore())}function ve(e,t,i){var r=t.x-e.x,n=t.y-e.y,o=r*r+n*n,a;0!==o&&(r*=a=i/Math.sqrt(o),n*=a,t.x+=r,t.y+=n,e.x-=r,e.y-=n)}function ue(e){S!==e&&(y.globalAlpha=e,S=e)}function ye(t){w!==t&&(t===e.NormalBlending?y.globalCompositeOperation='source-over':t===e.AdditiveBlending?y.globalCompositeOperation='lighter':t===e.SubtractiveBlending?y.globalCompositeOperation='darker':t===e.MultiplyBlending&&(y.globalCompositeOperation='multiply'),w=t)}function xe(e){R!==e&&(y.lineWidth=e,R=e)}function ge(e){b!==e&&(y.lineCap=e,b=e)}function Se(e){L!==e&&(y.lineJoin=e,L=e)}function we(e){M!==e&&(y.strokeStyle=e,M=e)}function Me(e){C!==e&&(y.fillStyle=e,C=e)}function Ce(e){T.length!==e.length&&(y.setLineDash(e),T=e)}void 0===y.setLineDash&&(y.setLineDash=function(){}),this.domElement=s,this.autoClear=!0,this.sortObjects=!0,this.sortElements=!0,this.info={render:{vertices:0,faces:0}},this.supportsVertexTextures=function(){},this.setFaceCulling=function(){},this.getContext=function(){return y},this.getContextAttributes=function(){return y.getContextAttributes()},this.getPixelRatio=function(){return u},this.setPixelRatio=function(e){void 0!==e&&(u=e)},this.setSize=function(e,t,i){l=e*u,c=t*u,s.width=l,s.height=c,p=Math.floor(l/2),d=Math.floor(c/2),!1!==i&&(s.style.width=e+'px',s.style.height=t+'px'),X.min.set(-p,-d),X.max.set(p,d),Y.min.set(-p,-d),Y.max.set(p,d),S=1,w=0,M=null,C=null,R=null,b=null,L=null,this.setViewport(0,0,e,t)},this.setViewport=function(e,t,i,r){f=e*u,h=t*u,m=i*u,v=r*u},this.setScissor=function(){},this.setScissorTest=function(){},this.setClearColor=function(e,t){x.set(e),g=void 0!==t?t:1,Y.min.set(-p,-d),Y.max.set(p,d)},this.setClearColorHex=function(e,t){console.warn('THREE.CanvasRenderer: .setClearColorHex() is being removed. Use .setClearColor() instead.'),this.setClearColor(e,t)},this.getClearColor=function(){return x},this.getClearAlpha=function(){return g},this.getMaxAnisotropy=function(){return 0},this.clear=function(){!1===Y.isEmpty()&&(Y.intersect(X),Y.expandByScalar(2),Y.min.x=Y.min.x+p,Y.min.y=-Y.min.y+d,Y.max.x=Y.max.x+p,Y.max.y=-Y.max.y+d,g<1&&y.clearRect(0|Y.min.x,0|Y.max.y,Y.max.x-Y.min.x|0,Y.min.y-Y.max.y|0),g>0&&(ue(1),ye(e.NormalBlending),Me('rgba('+Math.floor(255*x.r)+','+Math.floor(255*x.g)+','+Math.floor(255*x.b)+','+g+')'),y.fillRect(0|Y.min.x,0|Y.max.y,Y.max.x-Y.min.x|0,Y.min.y-Y.max.y|0)),Y.makeEmpty())},this.clearColor=function(){},this.clearDepth=function(){},this.clearStencil=function(){},this.render=function(t,s){if(void 0!==s.isCamera){var u=t.background;u&&u.isColor?(ue(1),ye(e.NormalBlending),Me(u.getStyle()),y.fillRect(0,0,l,c)):!0===this.autoClear&&this.clear(),i.info.render.vertices=0,i.info.render.faces=0,y.setTransform(m/l,0,0,-v/c,f,c-h),y.translate(p,d),r=a.projectScene(t,s,this.sortObjects,this.sortElements),n=r.elements,o=r.lights,ne.getNormalMatrix(s.matrixWorldInverse),oe();for(var x=0,g=n.length;x<g;x++){var S=n[x],w=S.material;if(void 0!==w&&0!==w.opacity){if(Z.makeEmpty(),S instanceof e.RenderableSprite)(B=S).x*=p,B.y*=d,se(B,S,w);else if(S instanceof e.RenderableLine)B=S.v1,E=S.v2,B.positionScreen.x*=p,B.positionScreen.y*=d,E.positionScreen.x*=p,E.positionScreen.y*=d,Z.setFromPoints([B.positionScreen,E.positionScreen]),!0===X.intersectsBox(Z)&&le(B,E,S,w);else if(S instanceof e.RenderableFace){if(B=S.v1,E=S.v2,P=S.v3,B.positionScreen.z<-1||B.positionScreen.z>1)continue;if(E.positionScreen.z<-1||E.positionScreen.z>1)continue;if(P.positionScreen.z<-1||P.positionScreen.z>1)continue;B.positionScreen.x*=p,B.positionScreen.y*=d,E.positionScreen.x*=p,E.positionScreen.y*=d,P.positionScreen.x*=p,P.positionScreen.y*=d,w.overdraw>0&&(ve(B.positionScreen,E.positionScreen,w.overdraw),ve(E.positionScreen,P.positionScreen,w.overdraw),ve(P.positionScreen,B.positionScreen,w.overdraw)),Z.setFromPoints([B.positionScreen,E.positionScreen,P.positionScreen]),!0===X.intersectsBox(Z)&&ce(B,E,P,0,1,2,S,w)}Y.union(Z)}}y.setTransform(1,0,0,1,0,0)}else console.error('THREE.CanvasRenderer.render: camera is not an instance of THREE.Camera.')}}});